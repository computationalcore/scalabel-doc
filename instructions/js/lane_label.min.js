(function(){var e=[];var i=document.getElementById("main_canvas");var t=i.getContext("2d");var r=document.getElementById("hidden_canvas");var s=r.getContext("2d");var n=document.getElementById("temp_canvas");var a=n.getContext("2d");var l=-1;var o=1;var d=false,h=false;var f,u,c;var p=true;var m=0;var v=1;var b=6;var w=1;var g=2;var y=1e4;var x="rgb(100,200,100)";var _="rgb(200,100,100)";var z="rgba(233, 133, 166, 0.7)";var P="rgb(100,0,100)";var B="rgba(200,200,100,0.7)";var L="rgba(150,0,120,0.5)";var E=.3;function C(e,i){return Math.abs(e[0]-i[0])+Math.abs(e[1]-i[1])}function I(e,i){if(e<i)return-1;else if(e>i)return 1;else return 0}function k(i){var t=i.list_index;e.splice(t,1);addEvent("deletePoly",i.id);num_poly-=1;$("#poly_count").text(num_poly);for(var r=t;r<e.length;r++){e[r].list_index--}}function O(){ratio=parseFloat(window.innerWidth/(1.35*source_image.width));if(parseFloat(window.innerHeight/(1.35*source_image.height))<ratio)ratio=parseFloat(window.innerHeight/(1.35*source_image.height));ratio=parseFloat(ratio.toFixed(6));u=Math.round(source_image.width*ratio);c=Math.round(source_image.height*ratio);console.log(u,c);i.style.width=u+"px";i.style.height=c+"px";r.style.width=u+"px";r.style.height=c+"px";n.style.width=u+"px";n.style.height=c+"px";i.height=c*2;i.width=u*2;r.height=c*2;r.width=u*2;n.height=c*2;n.width=u*2;t.scale(2,2);a.scale(2,2);s.scale(2,2)}function S(e){var i=0,t=0;for(var r=0;r<e.num;r++){i+=e.p[r][0];t+=e.p[r][1]}return[Math.round(i/e.num),Math.round(t/e.num)]}function F(){v=v<<1;if(v===2)$("#decrease_btn").attr("disabled",false);if(v===4){$("#increase_btn").attr("disabled",true)}u=u<<1;c=c<<1;i.style.width=u+"px";i.style.height=c+"px";n.style.width=u+"px";n.style.height=c+"px";r.style.width=u+"px";r.style.height=c+"px";document.getElementById("canvas_container").style.width=u+200+"px";document.getElementById("canvas_container").style.height=c+200+"px";document.getElementById("canvas_container").style.margin="10px";if(v>2){i.height=i.height<<1;i.width=i.width<<1;n.height=n.height<<1;n.width=n.width<<1;r.height=r.height<<1;r.width=r.width<<1;t.scale(v,v);s.scale(v,v);a.scale(v,v)}polyLabeling.redraw();polyLabeling.hidden_redraw()}function D(){v=v>>1;if(v===1)$("#decrease_btn").attr("disabled",true);if(v===2)$("#increase_btn").attr("disabled",false);u=u>>1;c=c>>1;i.style.width=u+"px";i.style.height=c+"px";n.style.width=u+"px";n.style.height=c+"px";r.style.width=u+"px";r.style.height=c+"px";document.getElementById("canvas_container").style.width=u+200+"px";document.getElementById("canvas_container").style.height=c+200+"px";document.getElementById("canvas_container").style.margin="10px";if(v===1)document.getElementById("canvas_container").style.width="0px";document.getElementById("canvas_container").style.height="0px";if(v>=2){i.height=i.height>>1;i.width=i.width>>1;n.height=n.height>>1;n.width=n.width>>1;r.height=r.height>>1;r.width=r.width>>1;t.scale(v,v);s.scale(v,v);a.scale(v,v)}polyLabeling.redraw();polyLabeling.hidden_redraw()}this.PolyLabeling=function(){function z(e){this.options=e;$("#main_canvas").css({"background-image":"url('"+this.options.url+"')",cursor:"crosshair"});return this.eventController()}z.prototype.updateImage=function(e){source_image=new Image;source_image.src=e;this.options.url=e;var i=this;$("#main_canvas").css({"background-image":"url('"+e+"')",cursor:"crosshair"});if(source_image.complete){O();i.replay()}else{source_image.onload=function(){O();i.replay()}}};z.prototype.DrawSelectVertex=function(e,i){var t=x;if(e===g)t=_;a.beginPath();a.arc(i[0],i[1],6/v,0,2*Math.PI,false);a.closePath();a.fillStyle=t;a.fill()};z.prototype.submitLabels=function(){this.output_labels=[];var i=[],t,r;for(var s in e){t=e[s];if(ratio){i=[];for(var n=0;n<t.num;n++){i[n]=[parseFloat((t.p[n][0]/ratio).toFixed(6)),parseFloat((t.p[n][1]/ratio).toFixed(6))]}}r={id:t.id.toString(),category:t.category,position:{density:t.density,dir:t.dir,list_index:t.list_index,p:i,num:t.num,BezierOffset:t.BezierOffset,beziernum:t.beziernum}};this.output_labels.push(r)}};z.prototype.redraw=function(r){var s,n;t.clearRect(0,0,i.width,i.height);if(e){for(key in e){if(r&&e[key]==r){continue}else{s=e[key];s.drawPoly(s.num,t);if(o){n=S(s);s.fillLabel(n,t)}}}}if(l!==-1&&f==="select"){l.drawPoly(l.num,t,true);n=S(l);l.fillLabel(n,t,true)}};z.prototype.hidden_redraw=function(){var i;s.clearRect(0,0,r.width,r.height);if(e){for(key in e){i=e[key];i.drawHiddenPoly(i.num)}}};z.prototype.clearGlobals=function(){d=false;h=false;this.resize=false;l=-1;f="free"};z.prototype.clearAll=function(){t.clearRect(0,0,i.width,i.height);s.clearRect(0,0,r.width,r.height);e=[];m=0;o=1;v=1;$("#label_btn").text("Hide Label (L)");$("#decrease_btn").attr("disabled",true);this.clearGlobals()};z.prototype.replay=function(){var n;n=this;if(typeof ratio==="undefined"||ratio<0){alert("Error when preloading. Please refresh page.");return}e=[];var a,l,o=-1;var d=image_list[current_index].labels;t.clearRect(0,0,i.width,i.height);s.clearRect(0,0,r.width,r.height);if(d){for(var h in d){if(!d.hasOwnProperty(h))continue;l=d[h];a=new V(l.category,parseInt(l.id));a.bbox=[1e4,1e4,-1,-1];a.list_index=l.position.list_index;if(a.id>o)o=a.id;for(var f=0;f<l.position.num;f++){a.p.push([parseFloat((l.position.p[f][0]*ratio).toFixed(6)),parseFloat((l.position.p[f][1]*ratio).toFixed(6))]);if(a.p[f][0]<a.bbox[0])a.bbox[0]=a.p[f][0];if(a.p[f][0]>a.bbox[2])a.bbox[2]=a.p[f][0];if(a.p[f][1]<a.bbox[1])a.bbox[1]=a.p[f][1];if(a.p[f][1]>a.bbox[3])a.bbox[3]=a.p[f][1];if(f>0){a.hidden_p[f-1]=[(a.p[f][0]+a.p[f-1][0])/2,(a.p[f][1]+a.p[f-1][1])/2]}}a.hidden_p[l.position.num-1]=[(a.p[l.position.num-1][0]+a.p[0][0])/2,(a.p[l.position.num-1][1]+a.p[0][1])/2];a.num=l.position.num;a.BezierOffset=l.position.BezierOffset;if(typeof l.position.density!=="undefined")a.density=l.position.density;if(typeof l.position.dir!=="undefined")a.dir=l.position.dir;a.beziernum=l.position.beziernum;a.ComputeDegree();e[a.list_index]=a}}n.redraw();n.hidden_redraw();m=o+1};z.prototype.SelectPoly=function(i,t){var r=2,n;if(v>2)r=v;n=s.getImageData(r*i,r*t,1,1).data;var a=-1;var l;if(n[0]!=0&&n[3]==255){l=n[0]-1;a=e[l]}return a};z.prototype.SelectPolyVertex=function(e,i){var t=2,r;if(v>2)t=v;r=s.getImageData(t*e,t*i,1,1).data;var n=-1;if(r[0]===0)return n;if(r[2]===0&&r[1]===0)return n;var a=r[1];var l=r[2];n=(a<<8|l)-1;return n};z.prototype.eventController=function(){var r;var s,_;var z=0;var P=false;var B,L,E,I=-1;var O=[];var H=null,R=null;r=this;f="free";function M(e){var t=i.getBoundingClientRect();var r=parseFloat(((e.clientX-t.left)*(u/t.width)).toFixed(6));var s=parseFloat(((e.clientY-t.top)*(c/t.height)).toFixed(6));r=parseFloat((r/v).toFixed(6));s=parseFloat((s/v).toFixed(6));if(f=="free"||f=="select"){if(r<0||s<0||r>u||s>c)return[-1,-1]}else{if(r<0)r=0;if(s<0)s=0;if(r>u/v)r=u/v;if(s>c/v)s=c/v}return[r,s]}function T(i){var u=M(i);var c=u[0],p=u[1];if(c<0||p<0)return;if(i.which===1){if(f=="free")z=0;if(f=="select"&&r.resize==0){r.clearGlobals();r.redraw();z=0;f="free"}if(f=="select"){if(r.resize>0){f="select_resize"}}else if(z===0&&f=="free"){l=-1;_=r.SelectPoly(c,p);if(r.resize==0){f="draw";var b=document.getElementById("category_select").selectedIndex;var w=document.getElementById("name_select").selectedIndex;var g=document.getElementById("dir_select").selectedIndex;var y=Catelist[b];s=new V(y,m);s.density=Featurelist[w];s.dir=Dirlist[g];s.list_index=e.length;d=false;h=false;s.update(c,p,0);z++;s.num++}else{f="resize"}}else{if(f=="finish_draw"){window.addEventListener("dblclick",Y,false);s.num=z;s.hidden_p[z-1]=[(s.p[z-1][0]+s.p[0][0])/2,(s.p[z-1][1]+s.p[0][1])/2];s.p.splice(z,1);s.hidden_p.splice(z,1);s.degree.splice(z,1);if(s.num==1)s.hidden_p=[];z=0;e.push(s);m+=1;num_poly+=1;$("#poly_count").text(num_poly);a.clearRect(0,0,n.width,n.height);r.clearGlobals();s.drawPoly(s.num,t,true);l=s;f="select";if(o){var x=S(s);s.fillLabel(x,t,true)}s.RecomputeBbox();s.drawHiddenPoly(s.num)}else if(f=="draw"){var P=C(s.p[z-1],[c,p]);_=r.SelectPoly(c,p);if(P>2/v){s.update(c,p,z);z++;s.num++;window.removeEventListener("dblclick",Y,false)}}}}return true}function G(e){if(r.resize>0){T(e);return}var i=M(e);if(i[0]<0||i[1]<0)return;var t=r.SelectPoly(i[0],i[1]);if(f=="select"){clearTimeout(H);H=setTimeout(function(){T(e)},300)}else if(f=="free"&&t!==-1){clearTimeout(H);H=setTimeout(function(){T(e)},300)}else{T(e)}}function W(e,i){s.p[z]=[e,i];s.num=z;O=[e,i];var t=b/v;if(C(O,s.p[0])<=t&&z>1){if(f=="draw")f="finish_draw";a.beginPath();a.arc(s.p[0][0],s.p[0][1],6/v,0,2*Math.PI,false);a.fillStyle=s.colors(s.id,1);a.closePath();a.fill();a.beginPath();a.arc(s.p[0][0],s.p[0][1],4/v,0,2*Math.PI,false);a.fillStyle=x;a.closePath();a.fill()}else{if(f=="draw"){var r=s.bbox;if(e<s.bbox[0])r[0]=e;if(e>s.bbox[2])r[2]=e;if(i<s.bbox[1])r[1]=i;if(i>s.bbox[3])r[3]=i;if(r[0]<4)r[0]=4;if(r[1]<4)r[1]=4;a.clearRect(r[0]-4,r[1]-4,r[2]-r[0]+8,r[3]-r[1]+8);s.drawPoly(z+1,a)}if(z>0){a.beginPath();a.arc(s.p[0][0],s.p[0][1],4/v,0,2*Math.PI,false);a.closePath();a.fillStyle=s.colors(s.id,.7);a.fill()}}}function N(e,i){if(B!=-1){if(h==false){B.showControlPoints(B.num,a);B.showControlPoints(B.num,a);I=B;h=true}if(B!=I){I.clearControlPoints(I.num,a);B.showControlPoints(B.num,a);I=B}if(r.resize==w){if(d==false){if(B.num>L){d=true;r.DrawSelectVertex(r.resize,B.p[L])}}}else if(r.resize==g){if(d==false){if(B.num>E){d=true;r.DrawSelectVertex(r.resize,B.hidden_p[E])}}}else{if(d==true){d=false;I.clearControlPoints(I.num,a)}}}else{if(d==true){d=false;r.resize=0;I.clearControlPoints(I.num,a)}if(h==true){h=false;r.resize=0;I.clearControlPoints(I.num,a);I=-1}}}function A(e){O=M(e);if(O[0]<0||O[1]<0){if(h===true){h=false;d=false;if(I!==-1){I.clearControlPoints(I.num,a)}}return}var i=O[0],t=O[1];if(f=="select"||f=="free"){r.resize=0;B=r.SelectPoly(i,t);if(f!="select"){L=r.SelectPolyVertex(i,t);if(L%2==0){L=L/2;E=-1}else if(L%2===1&&L!==-1){E=(L-1)/2;L=-1}else{L=-1;E=-1}}else{var n=y;var o=[];B=l;if(l!==-1){for(var u=0;u<l.num;u++){o=[C(O,l.p[u]),C(O,l.hidden_p[u])];if(u==l.num-1)o[1]=y;if(o[1]<n&&p){n=o[1];E=u;L=-1}if(o[0]<n){n=o[0];L=u;E=-1}}}if(n>=6/v){E=-1;L=-1;B=r.SelectPoly(i,t)}}if(!p)E=-1;var c=y,m=y;if(L!=-1&&B.num>L)c=C(O,B.p[L]);if(E!=-1&&B.num>E)m=C(O,B.hidden_p[E]);if(L!=-1&&E==-1&&c<6/v)r.resize=w;else if(L==-1&&E!=-1&&m<6/v)r.resize=g;else if(L!=-1&&E!=-1){if(c<m&&c<6/v)r.resize=w;else if(m<=c&&m<6/v)r.resize=g}else r.resize=0;if(r.resize==g){if(B.num<=E||B.num<=0){r.resize=0}else if(B.degree[E]==2||B.degree[(E+1)%B.num]==2){r.resize=0}}N(i,t)}else if(f=="draw"){W(i,t)}else if(f=="finish_draw"){if(C(O,s.p[0])>b/v){s.p[z]=[i,t];s.num=z;if(f=="finish_draw")f="draw";s.drawPoly(z+1,a)}}else if(f=="resize"||f=="select_resize"){_=r.SelectPoly(i,t);d=false;h=false;B.clearControlPoints(B.num,a);var x=B.bbox;if(i<B.bbox[0])x[0]=i;if(i>B.bbox[2])x[2]=i;if(t<B.bbox[1])x[1]=t;if(t>B.bbox[3])x[3]=t;if(x[0]<2)x[0]=2;if(x[1]<2)x[1]=2;a.clearRect(x[0]-2,x[1]-2,x[2]+4-x[0],x[3]+4-x[1]);if(r.resize==w){if(!P){r.redraw(B);P=true}B.p[L]=[i,t];B.ChangeHiddenVertex(L);B.ChangeHiddenVertex((L-1+B.num)%B.num);if(f=="resize"){B.drawPoly(B.num,a)}else if(f=="select_resize"){B.drawPoly(B.num,a,true)}}else if(r.resize==g){if(!P){B.GenarateNewVertex(E);r.redraw(B);P=true}B.p[E+1]=[i,t];B.ChangeHiddenVertex(E);B.ChangeHiddenVertex((E+1)%B.num);if(f=="resize"){B.drawPoly(B.num,a)}else if(f=="select_resize"){B.drawPoly(B.num,a,true)}}}}function j(i){if(f=="resize"||f=="select_resize"){P=false;z=0;if(B&&B!=-1)e[B.list_index]=B;if(f=="resize"){a.clearRect(0,0,n.width,n.height);if(!d){B.drawPoly(B.num,t)}r.clearGlobals();r.hidden_redraw()}else{a.clearRect(0,0,n.width,n.height);f="select";if(!d){B.drawPoly(B.num,t,true)}r.hidden_redraw()}B.RecomputeBbox();if(o){var s=S(B);if(f=="select")B.fillLabel(s,t,true);else B.fillLabel(s,t)}var l;if(ratio){l=[];for(var h=0;h<B.num;h++){l[h]=[parseFloat((B.p[h][0]/ratio).toFixed(6)),parseFloat((B.p[h][1]/ratio).toFixed(6))]}}addEvent("resize",B.id,{p:l,num:B.num,BezierOffset:B.BezierOffset,beziernum:B.beziernum})}}function K(i){var t=i.KeyCode?i.KeyCode:i.which;if(t===27){if(f=="draw"){z=0;a.clearRect(0,0,n.width,n.height);f="free";window.addEventListener("dblclick",Y,false);$("#toolhead").css("background-color","#DDDDDD");delete s}else if(d==true&&r.resize==w){B.clearControlPoints(B.num,a);if(B.degree[L]==0)B.DeleteVertex(L);else B.DeleteBezier(L);z=0;if(B.num>1)e[B.list_index]=B;if(B.num<=1){if(l==B){l=-1;f="free"}}if(f!="select")r.clearGlobals();else{d=false;h=false;r.resize=0}r.redraw();r.hidden_redraw()}else{alert("Nothing to delete!")}}else if(t===66){if(d==true&&r.resize==g){B.clearControlPoints(B.num,a);B.AddBezier(E);z=0;if(f!=="select")r.clearGlobals();else{d=false;h=false;r.resize=0}e[B.list_index]=B;r.hidden_redraw()}else{alert("Can not add Bezier Curve here!")}}else if(t===72){if(p){p=false;alert("Now the midpoints are invisiable, press <H> or"+" <h> again to show them. You can not add points "+"and curve until you press <H> or <h> again.");r.hidden_redraw()}else{p=true;alert("Now the midpoints are visiable, "+"you can add points and curve freely. "+"press <H> or <h> again to hide them.");r.hidden_redraw()}}else if(t===46||t===8){if(f!=="draw"&&d==true&&r.resize==w){B.clearControlPoints(B.num,a);if(B.degree[L]==0)B.DeleteVertex(L);else B.DeleteBezier(L);z=0;if(B.num>1)e[B.list_index]=B;if(B.num<=1){if(B==l){l=-1;f="free"}}if(f!="select")r.clearGlobals();else{d=false;h=false;r.resize=0}r.redraw();r.hidden_redraw()}else if(f=="select"){if(l!=-1){l.clearControlPoints(l.num,a);k(l);r.clearGlobals();r.redraw();r.hidden_redraw();z=0}else{alert("Please select the object you want to delete.")}}else if(f==="draw"){if(z>0){s.p.splice(z-1,1);s.degree.splice(z-1,1);if(z>1);s.hidden_p.splice(z-2,1);z--;s.num--;a.clearRect(0,0,n.width,n.height);if(z==0){f="free"}else{s.drawPoly(s.num,a)}}window.addEventListener("dblclick",Y,false)}else{alert("Nothing to delete!")}}else if(t===76){if(f=="free"||f=="select"){if(o===0){o=1;r.redraw();$("#label_btn").text("Hide Label (L)");if(f==="select"){d=false;h=false;r.resize=0}}else{o=0;r.redraw();$("#label_btn").text("Show Label (L)");if(f==="select"){d=false;h=false;r.resize=0}}}}else if(t===38){if(v===4)return;F()}else if(t===40){if(v===1)return;D()}}function Y(e){var i=M(e);var t=i[0],o=i[1];if(i[0]<0||i[1]<0){if(f==="select"){r.clearGlobals();r.redraw()}return}window.removeEventListener("mousedown",G,false);_=r.SelectPoly(t,o);clearTimeout(H);clearTimeout(R);if(f=="draw"){if(z>1&&s&&C(s.p[z-2],i)>b){window.addEventListener("mousedown",G,false);return}z=0;f="free";a.clearRect(0,0,n.width,n.height)}if(_!==-1){f="select";z=0;if(_!==l){l=_;var d,h;r.redraw();for(h=0;h<Catelist.length;h++){d=Catelist[h];if(d==_.category){$("#category_select").val(Catelist[h]);break}}$("#name_select").val(_.density);$("#dir_select").val(_.dir)}}else{if(f==="select"){r.clearGlobals();r.redraw()}}R=setTimeout(function(){window.addEventListener("mousedown",G,false)},350)}window.addEventListener("keydown",K,true);window.addEventListener("mousedown",G,false);window.addEventListener("mousemove",A,false);window.addEventListener("mouseup",j,false);window.addEventListener("dblclick",Y,false);$("#toolbox").mouseover(function(){window.removeEventListener("mousedown",G,false);window.removeEventListener("mousemove",A,false);window.removeEventListener("mouseup",j,false);window.removeEventListener("dblclick",Y,false)});$("#toolbox").mouseleave(function(){window.addEventListener("mousedown",G,false);window.addEventListener("mousemove",A,false);window.addEventListener("mouseup",j,false);window.addEventListener("dblclick",Y,false)});$("#pagination_control").mouseover(function(){window.removeEventListener("mousedown",G,false);window.removeEventListener("mousemove",A,false);window.removeEventListener("mouseup",j,false);window.removeEventListener("dblclick",Y,false)});$("#pagination_control").mouseleave(function(){window.addEventListener("mousedown",G,false);window.addEventListener("mousemove",A,false);window.addEventListener("mouseup",j,false);window.addEventListener("dblclick",Y,false)});$("#header").mouseover(function(){window.removeEventListener("mousedown",G,false);window.removeEventListener("mousemove",A,false);window.removeEventListener("mouseup",j,false);window.removeEventListener("dblclick",Y,false)});$("#header").mouseleave(function(){window.addEventListener("mousedown",G,false);window.addEventListener("mousemove",A,false);window.addEventListener("mouseup",j,false);window.addEventListener("dblclick",Y,false)});$("#delete_btn").click(function(){if(l!=-1){k(l);r.clearGlobals();r.redraw();r.hidden_redraw();z=0}else{alert("Please select the object you want to delete.")}});$("#increase_btn").click(function(){F()});$("#decrease_btn").click(function(){D()});$("#label_btn").click(function(){if(f=="free"||f=="select"){if(o===0){o=1;r.redraw();$("#label_btn").text("Hide Label (L)");if(f==="select"){d=false;h=false;r.resize=0}}else{o=0;r.redraw();$("#label_btn").text("Show Label (L)");if(f==="select"){d=false;h=false;r.resize=0}}}});$("#category_select").change(function(){var i=document.getElementById("category_select").selectedIndex;if(f=="select"){var t=Catelist[i];z=0;if(l!==-1){e[l.list_index].category=t;r.redraw()}d=false;h=false;r.resize=0}});$("#name_select").change(function(){if(f=="select"){var i=document.getElementById("name_select").selectedIndex;var t=Featurelist[i];z=0;if(l!==-1){e[l.list_index].density=t;r.redraw()}d=false;h=false;r.resize=0}});$("#dir_select").change(function(){if(f=="select"){var i=document.getElementById("dir_select").selectedIndex;var t=Dirlist[i];z=0;if(l!==-1){e[l.list_index].dir=t;r.redraw()}d=false;h=false;r.resize=0}})};return z}();var V;V=function(){function e(e,i){this.id=i;this.list_index=0;this.num=0;this.beziernum=0;this.p=[];this.degree=[];this.BezierOffset=[];this.hidden_p=[];this.category=e;this.density="full";this.dir="parallel";this.bbox=[1e4,1e4,-1,-1]}e.prototype.update=function(e,i,t){var r=[e,i];var s,n;this.p[t]=r;this.degree[t]=0;if(e<this.bbox[0])this.bbox[0]=e;if(e>this.bbox[2])this.bbox[2]=e;if(i<this.bbox[1])this.bbox[1]=i;if(i>this.bbox[3])this.bbox[3]=i;if(t>0){s=this.p[t-1][0];n=this.p[t-1][1];this.hidden_p[t-1]=[(e+s)/2,(i+n)/2]}return true};e.prototype.ComputeDegree=function(){for(var e=0;e<this.num;e++)this.degree[e]=0;if(this.beziernum>0){for(var i=0;i<this.beziernum;i++){var t=this.BezierOffset[i];this.degree[t]++;this.degree[t+1]=2;this.degree[t+2]=2;this.degree[(t+3)%this.num]++}}};e.prototype.AddBezier=function(e){var i=this.p[e];var t=this.p[(e+1)%this.num];this.num+=2;var r=[Math.round((i[0]*2+t[0])/3),Math.round((i[1]*2+t[1])/3)];var s=[Math.round((i[0]+t[0]*2)/3),Math.round((i[1]+t[1]*2)/3)];this.p.splice(e+1,0,r,s);this.hidden_p.splice(e,1);this.hidden_p.splice(e,0,0,0,0);this.ChangeHiddenVertex(e);this.ChangeHiddenVertex(e+1);this.ChangeHiddenVertex(e+2);this.degree.splice(e+1,0,2,2);this.degree[e]++;this.degree[(e+3)%this.num]++;this.beziernum++;this.BezierOffset.push(e);this.BezierOffset.sort(I);for(var n=0;n<this.beziernum;n++){if(this.BezierOffset[n]>e){this.BezierOffset[n]+=2}}addEvent("addBezier",this.id,{bezieroffset:this.BezierOffset,beziernum:this.beziernum})};e.prototype.DeleteBezier=function(e){var i=-1;for(var t=0;t<this.beziernum;t++){if(this.BezierOffset[t]<=e&&this.BezierOffset[t]+3>=e){i=t;break}else if(e==0&&this.BezierOffset[t]+3==this.num){i=t;break}}if(i==-1){alert("cannot delete bezier");return}var r=this.BezierOffset[i];this.num-=2;this.beziernum--;this.BezierOffset.splice(i,1);for(var t=i;t<this.beziernum;t++){this.BezierOffset[t]-=2}this.p.splice(r+1,2);this.degree.splice(r+1,2);this.degree[r]--;this.degree[(r+1)%this.num]--;this.hidden_p.splice(r,3);var s=[(this.p[r][0]+this.p[(r+1)%this.num][0])/2,(this.p[r][1]+this.p[(r+1)%this.num][1])/2];this.hidden_p.splice(r,0,s);addEvent("delBezier",this.id,{bezieroffset:this.BezierOffset,beziernum:this.beziernum})};e.prototype.drawPoly=function(e,i,t){var r=2;var s=false;if(this.beziernum>0)s=true;if(s==false){this.drawPolyWithoutBezier(e,i)}else if(s==true){this.drawPolyWithBezier(e,i)}if(t){i.strokeStyle=L;r=4}else i.strokeStyle=this.colors(this.id,1);i.lineWidth=r/v;i.stroke();if(s){this.drawDashLine(e,i)}};e.prototype.drawPolyWithoutBezier=function(e,i){i.beginPath();i.moveTo(this.p[0][0],this.p[0][1]);for(var t=1;t<e;t++){i.lineTo(this.p[t][0],this.p[t][1])}};e.prototype.drawPolyWithBezier=function(e,i){var t=this.beziernum;if(t==0)return;var r=this.BezierOffset[0];var s;var n=0;i.beginPath();i.moveTo(this.p[0][0],this.p[0][1]);for(var a=0;a<t;a++){r=this.BezierOffset[a];while(n<r){i.lineTo(this.p[n+1][0],this.p[n+1][1]);n++}i.bezierCurveTo(this.p[(r+1)%e][0],this.p[(r+1)%e][1],this.p[(r+2)%e][0],this.p[(r+2)%e][1],this.p[(r+3)%e][0],this.p[(r+3)%e][1]);n=(r+3)%e}while(n<e-1){i.lineTo(this.p[n+1][0],this.p[n+1][1]);n++}};e.prototype.drawDashLine=function(e,i){var t=this.beziernum;if(t==0)return;var r=this.BezierOffset[0];i.setLineDash([3]);for(var s=0;s<t;s++){r=this.BezierOffset[s];next_index=this.BezierOffset[(s+1)%t];i.moveTo(this.p[r][0],this.p[r][1]);i.lineTo(this.p[(r+1)%e][0],this.p[(r+1)%e][1]);i.lineTo(this.p[(r+2)%e][0],this.p[(r+2)%e][1]);i.lineTo(this.p[(r+3)%e][0],this.p[(r+3)%e][1]);i.stroke()}i.setLineDash([])};e.prototype.fillLabel=function(e,i,t){var r=this.category.indexOf(" ");var n;if(r>0)n=this.category.substring(0,1)+this.category.substring(r+1,r+2);else n=this.category.substring(0,2);n+=","+this.density.substring(0,1);n+=","+this.dir.substring(0,1);var a=n.length;var l=15;i.font="13px Verdana";if(v==4){i.font="9px Verdana";l=10;a=n.length-1}if(i==s){return}if(t)i.fillStyle=L;else i.fillStyle=this.colors(this.id,1);i.fillRect(e[0]-a,e[1]-2,a*9,l);i.fillStyle="rgb(0, 0, 0)";i.fillText(n,e[0]-a,e[1]+l-3)};e.prototype.drawHiddenPoly=function(e){s.strokeStyle=this.hidden_colors(this.list_index,-1);var i=false;if(this.beziernum>0)i=true;if(i==false){this.drawPolyWithoutBezier(e,s)}else if(i==true&&e>4){this.drawPolyWithBezier(e,s)}s.lineWidth=7/v;s.stroke();if(i&&e==4){var t=this.BezierOffset[0];s.beginPath();s.moveTo(this.p[t][0],this.p[t][1]);s.bezierCurveTo(this.p[(t+1)%e][0],this.p[(t+1)%e][1],this.p[(t+2)%e][0],this.p[(t+2)%e][1],this.p[(t+3)%e][0],this.p[(t+3)%e][1])}s.stroke();this.drawHiddenVertex(e);var r=S(this);this.fillLabel(r,s)};e.prototype.GenarateNewVertex=function(e){for(var i=this.num-1;i>e;i--){this.p[i+1]=this.p[i];this.hidden_p[i+1]=this.hidden_p[i]}this.p[e+1]=this.hidden_p[e];this.num++;this.degree.splice(e+1,0,0);for(var i=0;i<this.beziernum;i++){if(this.BezierOffset[i]>=e+1){this.BezierOffset[i]++}}this.ChangeHiddenVertex(e);this.ChangeHiddenVertex(e+1);addEvent("addvertex",this.id,{new_index:e})};e.prototype.DeleteVertex=function(e){if(this.num<=this.beziernum*3){return}this.num--;for(var i=0;i<this.beziernum;i++)this.BezierOffset[i]=this.BezierOffset[i]%this.num;this.p.splice(e,1);this.hidden_p.splice(e,1);this.degree.splice(e,1);if(this.num<2){k(this);return}for(var i=0;i<this.beziernum;i++){if(this.BezierOffset[i]>e){this.BezierOffset[i]--}}var t=(e-1+this.num)%this.num;this.ChangeHiddenVertex(t);addEvent("delvertex",this.id,{del_index:e})};e.prototype.ChangeHiddenVertex=function(e){var i=(e+1)%this.num;var e=e%this.num;this.hidden_p[e]=[(this.p[e][0]+this.p[i][0])/2,(this.p[e][1]+this.p[i][1])/2]};e.prototype.drawHiddenVertex=function(e){if(this.num>1&&p){for(var i=0;i<e-1;i++){if(e==2&&i==1)break;if(this.degree[i]<2&&this.degree[(i+1)%e]<2){s.beginPath();if(C(this.hidden_p[i],this.p[i])>b*2&&C(this.hidden_p[i],this.p[(i+1)%e])>b*2)s.arc(this.hidden_p[i][0],this.hidden_p[i][1],4/v,0,2*Math.PI,false);else s.arc(this.hidden_p[i][0],this.hidden_p[i][1],3/v,0,2*Math.PI,false);s.closePath();s.fillStyle=this.hidden_colors(this.list_index,2*i+1);s.fill()}}}for(var t=0;t<e;t++){s.beginPath();s.arc(this.p[t][0],this.p[t][1],4/v,0,2*Math.PI,false);s.closePath();s.fillStyle=this.hidden_colors(this.list_index,2*t);s.fill()}};e.prototype.clearControlPoints=function(e,i){var t=7/v;var r,s;for(var n=0;n<e;n++){r=[this.p[n][0]-t-1,this.p[n][1]-t-1];if(r[0]<0)r[0]=0;if(r[1]<0)r[1]=0;s=[this.p[n][0]+t+1,this.p[n][1]+t+1];i.clearRect(r[0],r[1],s[0],s[1]);r=[this.hidden_p[n][0]-t-1,this.hidden_p[n][1]-t-1];s=[this.hidden_p[n][0]+t+1,this.hidden_p[n][1]+t+1];i.clearRect(r[0],r[1],s[0],s[1])}};e.prototype.showControlPoints=function(e,i){var t=4/v;i.fillStyle=this.colors(this.id,.7);for(var r=0;r<e;r++){i.beginPath();i.arc(this.p[r][0],this.p[r][1],t,0,2*Math.PI,false);i.closePath();i.fill()}i.fillStyle=z;if(e<2)return;for(var r=0;r<e-1;r++){if(this.degree[r]<2&&this.degree[(r+1)%e]<2&&p){i.beginPath();i.arc(this.hidden_p[r][0],this.hidden_p[r][1],t,0,2*Math.PI,false);i.closePath();i.fill()}}if(this.beziernum>0){i.fillStyle=B;for(var s=0;s<this.beziernum;s++){var n=this.BezierOffset[s];for(var r=0;r<4;r++){i.beginPath();i.arc(this.p[n+r][0],this.p[n+r][1],t,0,2*Math.PI,false);i.closePath();i.fill()}}}};e.prototype.RecomputeBbox=function(){this.bbox=[1e4,1e4,-1,-1];for(var e=0;e<this.num;e++){if(this.p[e][0]<this.bbox[0])this.bbox[0]=this.p[e][0];if(this.p[e][0]>this.bbox[2])this.bbox[2]=this.p[e][0];if(this.p[e][1]<this.bbox[1])this.bbox[1]=this.p[e][1];if(this.p[e][1]>this.bbox[3])this.bbox[3]=this.p[e][1]}};e.prototype.colors=function(e,i){var t=["rgba(31, 119, 180, "+i+")","rgba(174, 199, 232, "+i+")","rgba(255, 127, 14, "+i+")","rgba(255, 187, 120, "+i+")","rgba(44, 160, 44,"+i+")","rgba(152, 223, 138,"+i+")","rgba(214, 39, 40, "+i+")","rgba(255, 152, 150,"+i+")","rgba(148, 103, 189, "+i+")","rgba(197, 176, 213, "+i+")","rgba(140, 86, 75, "+i+")","rgba(196, 156, 148,"+i+")","rgba(227, 119, 194, "+i+")","rgba(247, 182, 210, "+i+")","rgba(127, 127, 127, "+i+")","rgba(199, 199, 199, "+i+")","rgba(188, 189, 34, "+i+")","rgba(219, 219, 141, "+i+")","rgba(23, 190, 207,"+i+")","rgba(158, 218, 229, "+i+")"];return t[e%20]};e.prototype.hidden_colors=function(e,i){var t,r;i+=1;r=i&255;t=(i&255<<8)>>8;return"rgb("+(e+1)+","+t+","+r+")"};return e}()}).call(this);